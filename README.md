# Grassi Grosso

Сайт для компании Grassi Grosso.

## Установка и запуск

### Установка зависимостей

```bash
npm install
```

### Локальная разработка

**Вариант 1: Раздельно (рекомендуется для разработки)**
```bash
# Терминал 1 - Frontend
npm run dev

# Терминал 2 - Backend
node server.cjs
```

**Вариант 2: Вместе (если установлен concurrently)**
```bash
npm run dev:full
```

### Продакшен

1. Соберите фронтенд:
```bash
npm run build
```

2. Запустите сервер:
```bash
npm start
```

Сервер будет:
- Отдавать статику фронтенда из папки `dist`
- Обрабатывать API запросы на `/api/submit` и `/api/get-chat-id`

## Переменные окружения

Создайте файл `.env` в корне проекта:

```
BOT_TOKEN=ваш_токен_бота
CHAT_ID=ваш_chat_id
PORT=3000
```

**Важно:** 
- `BOT_TOKEN` и `CHAT_ID` обязательны для работы форм
- `PORT` обычно устанавливается автоматически на Timeweb Cloud Apps
- `VITE_API_URL` не нужна, так как используется относительный путь `/api/submit`

## Настройка для Timeweb Cloud Apps

**КРИТИЧЕСКИ ВАЖНО:** Приложение должно быть настроено как **Node.js приложение**, а не как статический сайт!

### Шаг 1: Проверьте тип приложения

1. Войдите в панель управления Timeweb Cloud Apps
2. Откройте настройки вашего приложения
3. **Убедитесь, что тип приложения установлен как "Node.js"**, а не "Статический сайт"
4. Если тип установлен как "Статический сайт", измените его на "Node.js"

### Шаг 2: Настройка деплоя

Timeweb Cloud Apps автоматически определит Node.js приложение по наличию `package.json` и файла `server.js`. Система:
- Автоматически выполнит `npm install` для установки зависимостей
- Автоматически выполнит `npm run build` для сборки фронтенда (если есть скрипт `build`)
- Запустит приложение через PM2, используя команду `npm start` из `package.json

**Важно:** Убедитесь, что в настройках деплоя:**
- **Команда сборки:** `npm run build` (опционально, если не указана, система может попытаться собрать автоматически)
- **Команда запуска:** `npm start` (уже указана в `package.json`)
- **Порт:** Оставьте автоматический (Timeweb установит переменную `PORT`)

### Шаг 3: Переменные окружения

Добавьте в настройках приложения следующие переменные окружения:
- `BOT_TOKEN` = ваш токен бота (получите у @BotFather)
- `CHAT_ID` = ваш chat ID (можно получить через `/api/get-chat-id` после деплоя)
- `PORT` (устанавливается автоматически, не нужно указывать вручную)

**⚠️ ВАЖНО:** Никогда не публикуйте токены и секреты в репозиторий!

### Шаг 4: Проверка после деплоя

После успешного деплоя проверьте:

1. **Фронтенд:** `https://ваш-домен.twc1.net/` - должен открываться сайт
2. **API GET тест:** `https://ваш-домен.twc1.net/api/test` - должен вернуть JSON: `{"message":"API работает!","timestamp":"..."}`
3. **API POST тест:** Откройте консоль браузера и выполните:
   ```javascript
   fetch('/api/test', {
     method: 'POST', 
     headers: {'Content-Type': 'application/json'}, 
     body: JSON.stringify({test: 'data'})
   }).then(r => r.json()).then(console.log)
   ```
   Должен вернуть JSON с сообщением "POST API работает!"

### Если API не работает (ошибка 405):

1. **Проверьте логи приложения** в панели Timeweb - должны быть видны запросы к `/api/*` и сообщения о запуске сервера
2. **Убедитесь, что тип приложения - Node.js**, а не статический сайт (это самая частая причина!)
3. **Проверьте, что в корне проекта есть:**
   - `package.json` с скриптом `"start": "node server.js"`
   - `server.js` - файл-обёртка для запуска (требует `server.cjs`)
   - `server.cjs` - основной файл сервера
4. **Пересоберите и перезапустите приложение** после изменения типа на Node.js
5. **Проверьте переменные окружения** - они должны быть установлены в настройках приложения

## Структура проекта

- `src/` - исходники фронтенда
- `server.js` - обёртка для Timeweb Cloud Apps (требует `server.cjs`)
- `server.cjs` - единый сервер для фронтенда и API
- `server/` - старый код бэкенда (можно удалить)
- `dist/` - собранный фронтенд (создается после `npm run build`)
